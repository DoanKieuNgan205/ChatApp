<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&family=Open+Sans:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>
<body>
  <div class="split-container">
    <div class="left-section">
      <div class="login-content">
        <h2>ÄÄƒng nháº­p</h2>
        <form id="loginForm">
          <input type="text" id="username" placeholder="TÃªn Ä‘Äƒng nháº­p" required />
          <input type="password" id="password" placeholder="Máº­t kháº©u" required />
          <button type="submit">ÄÄƒng nháº­p</button>
        </form>
        <div class="register-link">
          ChÆ°a cÃ³ tÃ i khoáº£n? <a href="register.html" id="registerLink">Táº¡o tÃ i khoáº£n ngay</a>
        </div>
        <p id="status"></p>
      </div>
    </div>
    <div class="right-section">
      <div class="logo-content">
        <lottie-player 
          src="logos/logo.json"  
          background="transparent"
          speed="1"
          loop
          autoplay>
        </lottie-player>
      </div>
    </div>
  </div>

<script>
(() => {
  const statusEl = document.getElementById('status');
  const formEl = document.getElementById('loginForm');

  let ws = null;

  function connectWS(callback) {
    ws = new WebSocket('ws://localhost:3000');

    ws.addEventListener('open', () => {
      console.log('[Frontend] âœ… WS connected to gateway');
      if (callback) callback(); 
    });

    ws.addEventListener('message', (ev) => {
      try {
        const data = JSON.parse(ev.data);
        console.log('[Frontend] ğŸ“© Received', data);

        if (data.action === 'login_response' || (data.status && data.message)) {
          if (data.status === 'success' && data.message === 'LOGIN_SUCCESS') {
            statusEl.style.color = 'green';
            statusEl.textContent = 'ÄÄƒng nháº­p thÃ nh cÃ´ng. Chuyá»ƒn tá»›i chat...';
            setTimeout(() => (window.location.href = 'chat.html'), 400);
          } else {
            statusEl.style.color = 'red';
            statusEl.textContent = 'Sai tÃ i khoáº£n hoáº·c máº­t kháº©u.';
          }
        }
      } catch (e) {
        console.warn('[Frontend] Non-JSON message:', ev.data);
      }
    });

    ws.addEventListener('close', () => {
      console.warn('[Frontend] âš ï¸ WS connection closed');
    });

    ws.addEventListener('error', (e) => {
      statusEl.style.color = 'red';
      statusEl.textContent = 'KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c gateway (ws://localhost:3000)';
      console.error(e);
    });
  }

  connectWS();

  formEl.addEventListener('submit', (evt) => {
    evt.preventDefault();

    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();

    if (!u || !p) {
      statusEl.style.color = 'red';
      statusEl.textContent = 'Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin';
      return;
    }

    sessionStorage.setItem('chat_username', u);

    const payload = { action: 'login', username: u, password: p };

    if (ws.readyState !== WebSocket.OPEN) {
      console.log('[Frontend] âš¡ WS not open, reconnecting...');
      statusEl.style.color = 'gray';
      statusEl.textContent = 'Äang káº¿t ná»‘i láº¡i...';

      connectWS(() => {
        console.log('[Frontend] ğŸ” Reconnected, sending login');
        ws.send(JSON.stringify(payload));
        statusEl.style.color = 'black';
        statusEl.textContent = 'Äang xÃ¡c thá»±c...';
      });
      return;
    }

    ws.send(JSON.stringify(payload));
    statusEl.style.color = 'black';
    statusEl.textContent = 'Äang xÃ¡c thá»±c...';
    console.log('[Frontend] Sent login', payload);
  });
})();
</script>
</body>
</html>
